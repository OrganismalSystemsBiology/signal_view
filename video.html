<html>
    <body>
        <div id="app">
            <p> start datetime: {{ startDT }} </p>
            <label for="input-video">{{ isLoading ? '読み込み中...' : ''}}</label>
            <input id="input-video" type="file" accept="video/*" @change="handleFileSelect">
            <video id="video" controls v-if="src" muted>
                <source :src="src" :alt="focusTime" type="video/webm">
                <source :src="src" :alt="focusTime" type="video/avi">
            </video>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script>
            new Vue({
                el: '#app',
                data: {
                    src: null,
                    isLoading: false,
                    focusTime: 0,
                    fasterDir: null,
                    startDT: '1970/01/01 00:00:00',
                },
                mounted() {
                    window.addEventListener('message', (e) => {
                        switch (e.data.action) {
                            case 'setIndex':
                                this.focusTime = e.data.message * 8;
                                video.currentTime = this.focusTime;
                                break;
                            case 'setAnalysisStartDT':
                                expInfoPath = e.data.message + "data\\exp.info.csv"
                                res = readCsvSync(expInfoPath, {columns:false, from_line: 1});
                                this.startDT = expInfoPath
                                break;
                        }
                    })
                },
                methods: {
                    handleFileSelect(event) {
                        // reset data
                        this.src = null
                        this.thumbnails = []
                        this.selected = 0

                        // varidate file
                        const file = event.target.files[0]
                        if (!file || !file.type.match('video/*')) return

                        // read file
                        const reader = new FileReader()
                        reader.onload = (evt) => {
                            this.src = evt.target.result
                            this.createThumbnails(this.src)
                            this.isLoading = false
                        }
                        reader.readAsDataURL(file)
                        this.isLoading = true
                    },
                    createThumbnails(src) {
                        const video = document.createElement('video')
                        const canvas = document.createElement('canvas')
                        const context = canvas.getContext('2d')

                        // set canvas
                        video.onloadeddata = () => {
                            canvas.width = video.videoWidth
                            canvas.height = video.videoHeight
                            video.currentTime = 0
                        }

                        // capture thumbnail
                        video.onseeked = () => {
                            if (video.currentTime < video.duration) {
                                context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight)
                                this.thumbnails.push(canvas.toDataURL('image/jpeg'))
                                video.currentTime += Math.ceil(video.duration / 4)
                            } else {
                                context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight)
                                this.thumbnails.push(canvas.toDataURL('image/jpeg'))
                            }
                        }

                        // set video source
                        video.src = src
                        video.load()
                    }
                }
            }),
            function readCsvSync(filename, options) {
                const fs = require('fs');
                const parse = require('csv-parse/lib/sync');
                const content = fs.readFileSync(filename).toString();
                return parse(content, options);
            }
        </script>
    </body>
</html>